/*! For license information please see 62.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[62],{98062:(i,t,e)=>{e.r(t),e.d(t,{default:()=>c});var s=e(69170),a=e(48913),n=e(97542),o=e(73339),l=e(54244),r=e(10374);class c extends n.Y{constructor(){super(...arguments),this.name="plugin",this.data=new o.e,this.allowLoad=!1}async init(i,t){if([this.ses,this.sdk,this.pluginConfigDataModule]=await Promise.all([t.getModuleBySymbol(s.y.SES),t.getModuleBySymbol(s.y.SDK),t.getModuleBySymbol(s.y.PLUGIN_CONFIG_DATA_MODULE)]),this.allowLoad=i.pluginPolicies.enabled,this.allowLoad){const i=t.subscribe(r.LZ,(async({phase:e,application:s})=>{e===l.nh.PLAYING&&(this.log.devInfo("Reached PLAYING stage, checking whether configured plugins need to load to start: ",s),s===l.Mx.SHOWCASE&&await this.loadConfigured(),this.bindings.push(t.subscribe(r.pB,(async i=>{if(this.log.devInfo("Switch in active application detected by plugin system: ",i.application),i.application===l.Mx.WORKSHOP)try{await this.disposeAll()}catch(i){this.log.debugWarn("Entering workshop, one or more plugins failed to dispose properly:",i)}else i.application===l.Mx.SHOWCASE&&await this.loadConfigured()}))),i.cancel())}))}t.market.register(this,o.e,this.data)}async loadConfigured(){if(this.pluginConfigDataModule.registryLoaded){const i=await this.pluginConfigDataModule.getConfiguredPlugins();if(this.log.debug("Combined configuration with registry data, loading plugins: "+JSON.stringify(i,void 0,2)),this.pluginConfigDataModule.pluginConfigData.disabled)return void this.log.debug("Cannot load plugins! Disabled by URL parameter.");const t=[];for(const e of i)t.push(this.load(e));try{await Promise.all(t)}catch(i){this.log.warn("Issues were encountered loading configured plugins.")}}}async fetchPlugin(i,t,e,s){s&&this.ses.freezeForStrict();const a=await this.ses.makeSecureEnvironment(i+""+(e?"-"+e:""),t,s);if(a){return[a,a.compartment.globalThis.plugin]}return null}async unload(i){const t=i.id&&""!==i.id?i.id:"default",e={applicationKey:i.applicationKey,id:t},s=this.data.get(e);let a=null;if(s){try{a=s.dispose()}catch(i){this.log.warn("An error occurred when disposing a plugin, it may be in a partially disposed state",i)}this.data.delete(e)}return a||Promise.resolve()}async load(i){const{applicationKey:t,src:e,id:s,strict:a}=i;if(!this.allowLoad){const i=e.startsWith("http")?e:`${e.substring(0,16)}...`;return Promise.reject(`Load for plugin <${s}:${i}> requested, but plugin system is not available.`)}const n=void 0===a||a,o=s||"default",l={applicationKey:t,id:o};if(this.data.get(l))return Promise.reject(`Plugin for ${t}-${o} already loaded.`);const[r,c]=await this.fetchPlugin(t,e,o,n)||[];r&&c&&await this.initPlugin(r,c.factory,i)}async initPlugin(i,t,e){const s=t(),{applicationKey:n,id:o,config:l}=e;let r=()=>{};const c=s.onInit||s.init;let d=Promise.resolve();if(c){class i{constructor(i){this.sdk=i}connect(){return this.sdk.connectPlugin(n)}cancelConnecting(){}}class t{getFactory(i){return i.messengerFactory}}const e=await a.tK.connect(new i(this.sdk),new t,window);d=c.call(s,e,l),r=()=>e.disconnect()}async function u(){const t=s.onDestroy||s.dispose;return((null==t?void 0:t.call(s))||Promise.resolve()).finally((()=>{r(),i.dispose()}))}const g={applicationKey:n,id:o};try{return await d,this.data.set(g,s,u),Promise.resolve()}catch(i){this.log.warn("Plugin initialization failed: ",i),this.log.debugWarn("Attemptying dispose for clean up...");try{await u()}catch(i){this.log.warn("Auto-cleanup of plugin had errors: ",i)}return Promise.reject(i)}}dispose(i){super.dispose(i),this.disposeAll().catch((i=>{this.log.warn("One or more plugins failed to dispose properly.",i)}))}disposeAll(){const i=[];for(const[t,e]of this.data.plugins.entries())i.push(e.dispose());return this.data.plugins.clear(),Promise.all(i)}}}}]);